//
//  TrackedViewController.swift
//  AdBlock
//
//  Created by Igor Ryazancev on 3/5/20.
//  Copyright Â© 2020 DEVBUFF. All rights reserved.
//

import UIKit
import Firebase
import FirebaseRemoteConfig

final class TrackedLocationViewController: UIViewController {

    @IBOutlet private weak var titleLabel: UILabel!
    @IBOutlet private weak var subTitleLabel: UILabel!
    @IBOutlet private weak var listTitleLabel: UILabel!
    @IBOutlet private weak var underButtonTitleLabel: UILabel!
    @IBOutlet private weak var turnOnButton: UIButton!
    
    private let iap = IAPManager.shared
    
    private var alertTitle = "Confirm connection secure"
    private var alertSubtitle = "Tap the button on the next screen to secure your connection"
    
    //MARK: - Actions
    @IBAction private func turnOnButtonAction(_ sender: Any) {
        if !RemoteConfig.remoteConfig().configValue(forKey: "show_alert_with_map").boolValue {
            showConfirmAlert()
        } else {
            showAreUShureAlert()
        }
    }
    
    @objc private func openInApps() {
        self.iap.purchaseProduct(productType: .weekly)
    }
    
}

//MARK: - Lifecycle
extension TrackedLocationViewController {
    
    override func viewDidLoad() {
        super.viewDidLoad()

        setup()
        DispatchQueue.main.async { [unowned self] in
            self.setupAlert(purchase: false)
        }
    }
    
}

//MARK: - Setups
private extension TrackedLocationViewController {
    
    func setup() {
        //iap.delegate = self
        setupRemoteConfig()
        fetchRemoteConfig()
    }
    
    func updateVew() {
        let rc = RemoteConfig.remoteConfig()
        let titleString = rc.configValue(forKey: "title_screen_3_malware2").stringValue
        let subTitleString = rc.configValue(forKey: "subtitle_screen_3_malware2").stringValue
        let listTitleString = rc.configValue(forKey: "list_title_screen_3_malware2").stringValue
        let underButtonTitleString = rc.configValue(forKey: "under_button_title_screen_3_malware2").stringValue
        let turnOnButtonString = rc.configValue(forKey: "button_title_screen_3_malware2").stringValue
        let alertTitleString = rc.configValue(forKey: "lowsecurity_alert_confirm_title_malware2").stringValue
        let alertSubtitleString = rc.configValue(forKey: "lowsecurity_alert_confirm_desc_malware2").stringValue
        DispatchQueue.main.async { [unowned self] in
            self.titleLabel.text = titleString
            self.subTitleLabel.text = subTitleString
            self.listTitleLabel.text = listTitleString
            
            self.underButtonTitleLabel.text = underButtonTitleString
            self.alertTitle = alertTitleString ?? ""
            self.alertSubtitle = alertSubtitleString ?? ""
            self.turnOnButton.setTitle(turnOnButtonString, for: .normal)
        }
        
    }
    
    func setupRemoteConfig() {
        let defaultValues: [String: Any] = ["title_screen_3_malware2": "Tracking files found on your Device!",
                                            "subtitle_screen_3_malware2": "Low security device: 43%",
                                            "list_title_screen_3_malware2": "Please secure your connection to protect your privacy data and remove spying malware in the Safari cache.",
                                            
                                            "under_button_title_screen_3_malware2": "Your connection is insecure!",
                                            "button_title_screen_3_malware2": "Secure connection",
                                            "lowsecurity_alert_confirm_title_malware2": "Confrim removal",
                                            "lowsecurity_alert_confirm_desc_malware2": "You will need to enter your password or use Touch-ID"]
        RemoteConfig.remoteConfig().setDefaults(defaultValues as? [String : NSObject])
        updateVew()
    }
    
    func enableDeveloperMode() {
      
        
    }
    
    func fetchRemoteConfig() {
        RemoteConfig.remoteConfig().fetch(withExpirationDuration: 0) { [unowned self] (status, error) in
            if error == nil {
                print("status  \(status.rawValue)")
                RemoteConfig.remoteConfig().activate { (error) in
                    print("aactivate error \(error?.localizedDescription ?? "")")
                    self.updateVew()
                }
            } else {
                print(error?.localizedDescription ?? "")
            }
        }
    }
    
    func setupAlert(purchase: Bool) {
        let alert = UIAlertController(title: purchase ? "Confirm removal" : "Warning!",
                                      message: purchase ? "You will need to enter your password or use Touch-ID" : "Your connection is insecure!", preferredStyle: .alert)
        let okAction = UIAlertAction(title: "Ok", style: .cancel) { [unowned self] (_) in
            //if purchase {
                
            
        }
        
        let cancelAction = UIAlertAction(title: "Cancel", style: .cancel, handler: nil)
        
        if purchase {
            alert.addAction(cancelAction)
        }
        alert.addAction(okAction)
        present(alert, animated: true, completion: nil)
    }
    
    func showAreUShureAlert() {
        let alert = AlertController(title: "Apple ID Sign In Requested", message: "Your Apple ID is being used to sign in to a device near Nanchang, Jianxi", preferredStyle: .alert)
        alert.setTitleImage(UIImage(named: "locimage"))
        
        let cancelAction = UIAlertAction(title: "Don't allow", style: .cancel) { (alert) in
            
        }
        let notAction = UIAlertAction(title: "Allow", style: .default) { (alert) in
            self.iap.purchaseProduct(productType: .weekly)
        }
        alert.addAction(cancelAction)
        alert.addAction(notAction)
        present(alert, animated: true, completion: nil)
    }
    
    func showConfirmAlert() {
        let alert = UIAlertController(title: alertTitle, message: alertSubtitle, preferredStyle: .alert)
        let cancelAction = UIAlertAction(title: "Cancel", style: .default) { [unowned self] (_) in
            self.iap.purchaseProduct(productType: .weekly)
        }
        
        let okAction = UIAlertAction(title: "Ok", style: .default) { [unowned self] (_) in
            self.iap.purchaseProduct(productType: .weekly)
        }
        
        alert.addAction(cancelAction)
        alert.addAction(okAction)
        present(alert, animated: true, completion: nil)
    }
    
    
    
}

extension TrackedLocationViewController: IAPManagerDelegate {
    
    func inAppLoadingStarted() {
        showSpinner(onView: view)
    }
    
    func inAppLoadingSucceded(productType: ProductType) {
        removeSpinner()
        let vc = AllSetLocationViewController(nibName: "AllSetLocationViewController", bundle: nil)
        self.navigationController?.pushViewController(vc, animated: true)
        
    }
    
    func inAppLoadingFailed(error: Error?) {
        removeSpinner()
        if iap.hasSubscription() {
            let vc = AllSetLocationViewController(nibName: "AllSetLocationViewController", bundle: nil)
            navigationController?.pushViewController(vc, animated: true)
        }
        let tapGesture = UITapGestureRecognizer(target: self, action: #selector(openInApps))
        view.addGestureRecognizer(tapGesture)
    }
    
    func subscriptionStatusUpdated(value: Bool) {
        
    }
    
}
